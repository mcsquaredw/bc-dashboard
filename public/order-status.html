<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Big Change Dashboard</title>
  <script src="js/lib/axios.min.js"></script>
  <script src="js/lib/jquery.min.js"></script>
  <script src="js/lib/bootstrap.min.js"></script>
  <script src="js/utils.js"></script>
  
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/kanban.css" rel="stylesheet" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">
      <img src="img/jb-logo.png" />
    </a>
    <h4>Big Change - Door Order Status (WORK IN PROGRESS)</h4>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

 <div class="collapse navbar-collapse" id="navbarSupportedContent">
   <ul class="navbar-nav ml-auto">
     <li class="nav-item dropdown">
       <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
         Reports
       </a>
       <div id="mainMenu" class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
       </div>
     </li>
   </ul>
  </nav>
  <div>
    <div class="dd">
        <div id="lists">
        </div>
    </div>
  </div>
  <script type="text/javascript">
    function getData() {
        console.log("Updating from Big Change");
        axios.get(`jb/flags`).then(flagResponse => {
            const flags = flagResponse.data.Result;

            axios.get(`/jb/all-jobs`).then(response => {
                let lists = document.getElementById("lists");

                let orderPlacedTitle = document.createElement("h2");
                let orderPlaced = document.createElement("ol");
                orderPlacedTitle.appendChild(document.createTextNode("Order Placed"));
                orderPlaced.classList.add("kanban");
                orderPlaced.appendChild(orderPlacedTitle);
                
                let doorToOrderTitle = document.createElement("h2");
                let doorToOrder = document.createElement("ol");
                doorToOrderTitle.appendChild(document.createTextNode("Door To Order"));
                doorToOrder.classList.add("kanban");
                doorToOrder.appendChild(doorToOrderTitle);

                let ackTitle = document.createElement("h2");
                let ack = document.createElement("ol");
                ackTitle.appendChild(document.createTextNode("Ordered - Not Acknowledged"));
                ack.classList.add("kanban");
                ack.appendChild(ackTitle);

                let toDeliverTitle = document.createElement("h2");
                let toDeliver = document.createElement("ol");
                toDeliverTitle.appendChild(document.createTextNode("To Deliver"));
                toDeliver.classList.add("kanban");
                toDeliver.appendChild(toDeliverTitle);

                let readyToFitTitle = document.createElement("h2");
                let readyToFit = document.createElement("ol");
                readyToFitTitle.appendChild(document.createTextNode("Ready To Fit"));
                readyToFit.classList.add("kanban");
                readyToFit.appendChild(readyToFitTitle);

                let fittedTitle = document.createElement("h2");
                let fitted = document.createElement("ol");
                fittedTitle.appendChild(document.createTextNode("Fitted - To Pay"));
                fitted.classList.add("kanban");
                fitted.appendChild(fittedTitle);

                let followUpTitle = document.createElement("h2");
                let followUp = document.createElement("ol");
                followUpTitle.appendChild(document.createTextNode("Fitted - Followup Required"));
                followUp.classList.add("kanban");
                followUp.appendChild(followUpTitle);

                let uncatTitle = document.createElement("h2");
                let uncat = document.createElement("ol");
                uncatTitle.appendChild(document.createTextNode("Uncategorised - Check for Errors!"));
                uncat.classList.add("kanban");
                uncat.appendChild(uncatTitle);

                let unflagged = false;

                response.data.Result.sort((a, b) => {
                    let aDate = new Date(a.PlannedStart);
                    let bDate = new Date(b.PlannedStart);
                    
                    return aDate - bDate;
                }).map((job, index) => {
                    if(job.CurrentFlag) {
                        if(job.CurrentFlag.includes("SF03")) {
                            orderPlaced.innerHTML += `
                                <li class="dd-item" data-id="${index}" style="background-color:${flags.filter(flag => flag.tagName === job.CurrentFlag).map(flag => flag.colour)};">
                                    <h3 class="title dd-handle"><i class="material-icons">${renderAlertLevelIcon(job)}</i>${toTitleCase(job.Contact)} ${job.Postcode}</h3>
                                    <div class="text text-dark">
                                        Surveyed ${formatDate(job.PlannedStart)} by <br />
                                        ${job.Resource}
                                    </div>
                                </li>
                            `;
                        } else if(job.CurrentFlag.includes("IF02")) {
                            doorToOrder.innerHTML += `
                                <li class="dd-item text-light" style="background-color:${flags.filter(flag => flag.tagName === job.CurrentFlag).map(flag => flag.colour)};" data-id="${index}">
                                    <h3 class="title dd-handle"><i class="material-icons">${renderAlertLevelIcon(job)}</i>${toTitleCase(job.Contact)} ${job.Postcode}</h3>
                                    <div class="text text-light">
                                        ${job.Type} To Be Fitted ${formatDate(job.PlannedStart)}
                                    </div>
                                </li>
                            `;
                        } else if(job.CurrentFlag.includes("IF06")) {
                            ack.innerHTML += `
                                <li class="dd-item text-light"  style="background-color:${flags.filter(flag => flag.tagName === job.CurrentFlag).map(flag => flag.colour)};" data-id="${index}">
                                    <h3 class="title dd-handle"><i class="material-icons">${renderAlertLevelIcon(job)}</i>${toTitleCase(job.Contact)} ${job.Postcode}</h3>
                                    <div class="text text-light">
                                        ${job.Type} To Be Fitted ${formatDate(job.PlannedStart)}
                                    </div>
                                </li>
                            `;
                        } else if(job.CurrentFlag.includes("IF03")) {
                            toDeliver.innerHTML += `
                                <li class="dd-item" style="background-color:${flags.filter(flag => flag.tagName === job.CurrentFlag).map(flag => flag.colour)};" data-id="${index}">
                                    <h3 class="title dd-handle"><i class="material-icons">${renderAlertLevelIcon(job)}</i>${toTitleCase(job.Contact)} ${job.Postcode}</h3>
                                    <div class="text text-dark">
                                        ${job.PlannedStart ? `${job.Type} To Be Fitted ${formatDate(job.PlannedStart)}` : `NO FITTING DATE!`}
                                    </div>
                                </li>
                            `;
                        } else if(job.CurrentFlag.includes("IF01")) {
                            if(job.RealEnd) {
                                if(job.Status.includes("issues")) {
                                    followUp.innerHTML += `                                
                                        <li class="dd-item text-light" style="background-color:${flags.filter(flag => flag.tagName === job.CurrentFlag).map(flag => flag.colour)};" data-id="${index}">
                                            <h3 class="title dd-handle"><i class="material-icons">feedback</i>${toTitleCase(job.Contact)} ${job.Postcode}</h3>
                                            <div class="text text-light">
                                                ${job.Type} Fitted ${formatDate(job.RealEnd)}
                                            </div>
                                        </li>`;
                                } else {
                                    fitted.innerHTML += `
                                        <li class="dd-item text-light" style="background-color:${flags.filter(flag => flag.tagName === job.CurrentFlag).map(flag => flag.colour)};" data-id="${index}">
                                            <h3 class="title dd-handle"><i class="material-icons">credit_card</i>${toTitleCase(job.Contact)} ${job.Postcode}</h3>
                                            <div class="text text-light">
                                                ${job.Type} Fitted ${formatDate(job.RealEnd)}
                                            </div>
                                        </li>`;
                                }
                            } else {
                                readyToFit.innerHTML += `
                                    <li class="dd-item text-light"  style="background-color:${flags.filter(flag => flag.tagName === job.CurrentFlag).map(flag => flag.colour)};" data-id="${index}">
                                        <h3 class="title dd-handle"><i class="material-icons">${renderAlertLevelIcon(job)}</i>${toTitleCase(job.Contact)} ${job.Postcode}</h3>
                                        <div class="text text-light">
                                            ${job.Type} To Be Fitted ${formatDate(job.PlannedEnd)}
                                        </div>
                                    </li>`;
                            }                       
                        } else if (!job.CurrentFlag) {
                            unflagged = true;
                            uncat.innerHTML += `
                                <li class="dd-item bg-danger text-light" data-id="${index}">
                                    <h3 class="title dd-handle">${toTitleCase(job.Contact)} ${job.Postcode}</h3>
                                    <div class="text text-light">
                                        ${job.Type}
                                    </div>
                                </li>
                            `;
                        }
                    }
                });

                 lists.appendChild(orderPlaced);
                lists.appendChild(doorToOrder);
                lists.appendChild(ack);
                lists.appendChild(toDeliver);
                lists.appendChild(readyToFit);
                lists.appendChild(fitted);
                lists.appendChild(followUp);
                if(unflagged) {
                    lists.appendChild(uncat);
                }
            }).catch(err => {
                console.log(err);
            });
        }).catch(err => {
            console.log(err);
        });
    }   

    getData();
</script>
<script src="js/menu.js"></script>
</body>
</html>
