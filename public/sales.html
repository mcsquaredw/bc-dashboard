<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Big Change Dashboard</title>
  <script src="js/lib/axios.min.js"></script>
  <script src="js/lib/jquery.min.js"></script>
  <script src="js/lib/bootstrap.min.js"></script>
  <script src="js/lib/Chart.min.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/display.js"></script>
  <script src="js/pieChart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet" />
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">
      <img src="img/jb-logo.png" />
    </a>
    <h4>Big Change - Sales Report</h4>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
   <span class="navbar-toggler-icon"></span>
 </button>

 <div class="collapse navbar-collapse" id="navbarSupportedContent">
   <ul class="navbar-nav ml-auto">
     <li class="nav-item dropdown">
       <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
         Reports
       </a>
       <div id="mainMenu" class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
       </div>
     </li>
   </ul>
  </nav>
  <div>
    <div class="container-fluid">
      <div class="row">
        <div class="col">
          <form class="form-inline">
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text">Start Date</span>
              </div>
              <input id="start" type="date" class="form-control" id="start" name="start" min="2018-01-01" onchange="onkeyup" />
            </div>
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text">End Date</span>
              </div>
              <input id="end" type="date" class="form-control" id="end" name="end" min="2018-01-01" onchange="onkeyup" />
            </div>
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text">Surveyor</span>
              </div>
              <select id="surveyor" name="surveyor">
                <option selected value="Andy Marshall">Andy Marshall</option>
                <option value="Jason Housby">Jason Housby</option>
              </select>
            </div>
          </form>
          <canvas id="chart"></canvas>
        </div>
        <div class="col">
          <table class="table table-sm">
            <thead>
              <tr>
                <th scope="col">Customer</th>
                <th scope="col">Flag</th>
                <th scope="col">Survey Date</th>
              </tr>
            </thead>
            <tbody id="jobs">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    var startDate = new Date();
    var endDate = new Date();
    endDate.setDate(endDate.getDate() + 1);

    document.getElementById('start').valueAsDate = startDate;
    document.getElementById('end').valueAsDate = endDate;
    
    var surveyor = document.getElementById('surveyor').value; 

    function getData() {
      console.log("Updating from Big Change");

      axios.get(`/jb/sales/${util_dateToString(startDate)}/${util_dateToString(endDate)}`).then(response => {
        const data = response.data.Result;
        const table = document.getElementById('jobs');
        
        var sold = 0;
        var followup = 0;
        var notsold = 0;
        var notset = 0;
        var total = 0;

        removeChildren(jobs);

        data.sort(sortJobs).map((job, index) => {
          if(job.Resource && job.Resource.includes(surveyor) && (job.Type.includes("Survey"))) {
            const row = document.createElement('tr');
            const tdCustomer = document.createElement('td');
            const tdFlag = document.createElement('td');
            const tdFittingDate = document.createElement('td');

            total += 1;

            tdCustomer.appendChild(document.createTextNode(job.Contact ? job.Contact + " " + job.Postcode : "NOT SET"));
            row.appendChild(tdCustomer);

            tdFlag.appendChild(document.createTextNode(job.CurrentFlag ? job.CurrentFlag : "NOT SET"));
            row.appendChild(tdFlag);

            tdFittingDate.appendChild(document.createTextNode(job.PlannedStart ? formatDate(job.PlannedStart) : "NOT SET"));
            row.appendChild(tdFittingDate);

            if(job.CurrentFlag) {
              if(job.CurrentFlag.includes("SF01")) {
                row.classList.add('table-danger');
                notsold += 1;
              }

              if(job.CurrentFlag.includes("SF02")) {
                row.classList.add('table-warning');
                followup += 1;
              }

              if(job.CurrentFlag.includes("SF03") || job.CurrentFlag.includes("SF04")) {
                row.classList.add('table-success');
                sold += 1;
              }
            } else {
              row.classList.add('table-danger');
              row.classList.add('text-danger');
              notset += 1;
            }
            table.appendChild(row);
          }
        });
        renderChart(
          "Sales Report", 
          [
              `Sold (${sold} Sales) ${(sold / total * 100).toFixed(2)}%`,
              `To Follow Up (${followup} Sales) ${(followup / total * 100).toFixed(2)}%`,
              `Not Sold (${notsold} Sales) ${(notsold / total * 100).toFixed(2)}%`,
              `Not Set (${notset} Sales) ${(notset / total * 100).toFixed(2)}%`
          ],
          [
            sold,
            followup,
            notsold,
            notset
          ],
          [ 
            'rgb(75, 192, 192)', 
            'rgb(255, 205, 86)', 
            'rgb(255, 99, 132)', 
            'rgb(51, 51, 255)' 
          ]
        );
      }).catch(err => {
        console.log(err);
      });   
    }

    getData();

    setInterval(() => {
      var newStartDate = document.getElementById('start').valueAsDate;
      var newEndDate = document.getElementById('end').valueAsDate;
      var newSurveyor = document.getElementById('surveyor').value;

      if(newStartDate.getTime() !== startDate.getTime() || newEndDate.getTime() !== endDate.getTime() || newSurveyor !== surveyor) {
        startDate = document.getElementById('start').valueAsDate;
        endDate = document.getElementById('end').valueAsDate;
        surveyor = document.getElementById('surveyor').value;
        getData();
      }
    }, 1000);

    setInterval(getData, 300000);
  </script>
  <script src="js/menu.js"></script>
</body>
</html>
